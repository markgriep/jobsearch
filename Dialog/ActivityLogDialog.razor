@using MudBlazor
@using jobsearch.Models
@using Microsoft.AspNetCore.Components.Web
@using System.Globalization
@inject ISnackbar Snackbar

 

<MudDialog>
    <DialogContent>
        <MudGrid Spacing="3">

          

            <!-- Row 1 -->
            <MudItem xs="12" sm="6">
                <MudTextField Variant="Variant.Outlined"
                           
                              @bind-Value="_edit.BusinessOrOrganization"
                              Label="Business / Organization"
                              Required />
            </MudItem>

            <MudItem xs="12" sm="3">
                <MudTextField Variant="Variant.Outlined"
                              @bind-Value="_edit.TypeOfWork"
                              Label="Type of Work"
                              Required />
            </MudItem>

          

            <MudItem xs="12" sm="3">
                <MudTextField Variant="Variant.Outlined"
                              @bind-Value="_edit.ContactPerson"
                              Label="Contact Person" />
            </MudItem>


            <!-- Row 2 -->
            <MudItem xs="12" sm="3">
                <MudTextField @ref="activityDateField" 
                              Variant="Variant.Outlined"
                              InputType="InputType.Date"
                              @bind-Value="ActivityDateText" 
                              Label="Date"
                              @onkeydown="OnDateKeyDown"
                              Required />
            </MudItem>

            <MudItem xs="12" sm="5">
                <MudTextField Variant="Variant.Outlined"
                              @bind-Value="_edit.ActivityPerformed"
                              Label="Activity Performed"
                              Required />
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudTextField Variant="Variant.Outlined"
                              @bind-Value="_edit.HowPerformed"
                              Label="How Performed" />
            </MudItem>

          



            <!-- Row 3 -->
            <MudItem xs="12">
                <MudTextField Variant="Variant.Outlined"
                              @bind-Value="_edit.Results"
                              Label="Results"
                              Required />
            </MudItem>

            <!-- DES Flags -->
            <MudItem xs="12" sm="6">
                <MudCheckBox T="bool"
                              @bind-Value="_edit.ShouldBeOnDes"
                              Label="Should Be On DES" />
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudCheckBox T="bool"
                              @bind-Value="_edit.IsOnDes"
                              Label="Is Entered On DES" />
            </MudItem>

            <!-- Notes -->
            <MudItem xs="12">
                <MudExpansionPanel Text="Notes" Elevation="3">
                    <MudTextField Variant="Variant.Outlined"
                                  @bind-Value="_edit.Notes"
                                  Label="Notes"
                                  Lines="4" />
                </MudExpansionPanel>
            </MudItem>

        </MudGrid>
    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" OnClick="Save">Save</MudButton>
    </DialogActions>
</MudDialog>



@code {
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public ActivityLog Model { get; set; } = new();

    private ActivityLog _edit = new();

    private const string DateFormat = "yyyy-MM-dd";
    private string _activityDateText = string.Empty;

    private MudTextField<string> activityDateField = default!;

    protected override void OnInitialized()
    {
        InitializeEditModel();
    }

    private void InitializeEditModel()
    {
        // work on a copy so Cancel doesn't mutate the original row
        _edit = new ActivityLog
        {
            Id = Model.Id,
            ActivityDate = Model.ActivityDate,
            BusinessOrOrganization = Model.BusinessOrOrganization,
            ActivityPerformed = Model.ActivityPerformed,
            TypeOfWork = Model.TypeOfWork,
            Results = Model.Results,
            ContactPerson = Model.ContactPerson,
            HowPerformed = Model.HowPerformed,
            Notes = Model.Notes,
            ShouldBeOnDes = Model.ShouldBeOnDes,
            IsOnDes = Model.IsOnDes
        };

        if (_edit.ActivityDate == default)
            _edit.ActivityDate = DateTime.Today;

        _activityDateText = _edit.ActivityDate.ToString(DateFormat, CultureInfo.InvariantCulture);
    }

    private string ActivityDateText
    {
        get => _activityDateText;
        set
        {
            _activityDateText = value;

            if (DateTime.TryParseExact(value, DateFormat, CultureInfo.InvariantCulture, DateTimeStyles.None, out var parsed))
            {
                _edit.ActivityDate = parsed.Date;
            }
        }
    }

    private async Task OnDateKeyDown(KeyboardEventArgs e)
    {
        if (e.Key.Equals("t", StringComparison.OrdinalIgnoreCase))
        {
            SetActivityDate(DateTime.Today);
            await activityDateField.SetText(ActivityDateText);
        }
        else if (e.Key == "+" || e.Key == "=")
        {
            SetActivityDate(_edit.ActivityDate.AddDays(1));
            await activityDateField.SetText(ActivityDateText);
        }
        else if (e.Key == "-")
        {
            SetActivityDate(_edit.ActivityDate.AddDays(-1));
            await activityDateField.SetText(ActivityDateText);
        }
    }

    private void SetActivityDate(DateTime date)
    {
        _edit.ActivityDate = date.Date;
        _activityDateText = _edit.ActivityDate.ToString(DateFormat, CultureInfo.InvariantCulture);
    }


    private void Cancel() => MudDialog.Cancel();


    private void Save() => MudDialog.Close(DialogResult.Ok(_edit));
}
