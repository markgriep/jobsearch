@page "/tracker"

@inject jobsearch.Data.JobSearchDbContext Db
@inject ISnackbar Snackbar
@inject IDialogService DialogService

@using Microsoft.EntityFrameworkCore
@using jobsearch.Dialog




<PageTitle>Job Search Info</PageTitle>

<div class="d-flex align-center" style="gap:8px;">
    <p class="m-0">Row Count: @count</p>
    <MudButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small" OnClick="@Add" />
</div>

<MudTable Items="_rows" Hover="true" Dense="true">
    <HeaderContent>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x => x.ActivityDate)">Date</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x => x.BusinessOrOrganization)">Business</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x => x.ActivityPerformed)">Activity</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x => x.TypeOfWork)">Type</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x => x.Results)">Results</MudTableSortLabel></MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>

    <RowTemplate>
        <MudTd DataLabel="Date">@context.ActivityDate</MudTd>
        <MudTd DataLabel="Business">@context.BusinessOrOrganization</MudTd>
        <MudTd DataLabel="Activity">@context.ActivityPerformed</MudTd>
        <MudTd DataLabel="Type">@context.TypeOfWork</MudTd>
        <MudTd DataLabel="Results">@context.Results</MudTd>
        <MudTd>
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" AriaLabel="Edit" OnClick="@(() => Edit(context))" />
        </MudTd>
    </RowTemplate>
</MudTable>

<style>
    .dialog-blur-background {
        backdrop-filter: blur(5px);
        background-color: rgba(255, 255, 255, 0.2);
     
    }
</style>

@code {
    int count;
    private List<ActivityLog> _rows = new();

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    private async Task ReloadAsync()
    {
        count = await Db.ActivityLogs.CountAsync();
        _rows = await Db.ActivityLogs
            .OrderByDescending(x => x.ActivityDate)
            .ToListAsync();
        StateHasChanged();
    }

    private async Task Add()
    {
        var parameters = new DialogParameters { ["Model"] = new ActivityLog() };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true, BackgroundClass = "dialog-blur-background" };
        var dialog = DialogService.Show<ActivityLogDialog>("Add Activity", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled && result.Data is ActivityLog added)
        {
            try
            {
                // Ensure all required fields are populated
                if (string.IsNullOrWhiteSpace(added.ActivityDate))
                    added.ActivityDate = DateTime.Today.ToString("yyyy-MM-dd");
                
                Db.ActivityLogs.Add(added);
                int changes = await Db.SaveChangesAsync();
                
                if (changes > 0)
                {
                    Snackbar.Add($"Activity added successfully", Severity.Success);
                    await ReloadAsync();
                }
                else
                {
                    Snackbar.Add("Warning: No changes were saved", Severity.Warning);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error saving: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task Edit(ActivityLog row)
    {
        var parameters = new DialogParameters { ["Model"] = row };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true, BackgroundClass = "dialog-blur-background" };
        var dialog = DialogService.Show<ActivityLogDialog>("Edit Activity", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled && result.Data is ActivityLog edited)
        {
            try
            {
                Db.ActivityLogs.Update(edited);
                int changes = await Db.SaveChangesAsync();
                
                if (changes > 0)
                {
                    Snackbar.Add($"Activity updated successfully", Severity.Success);
                    await ReloadAsync();
                }
                else
                {
                    Snackbar.Add("Warning: No changes were saved", Severity.Warning);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error saving: {ex.Message}", Severity.Error);
            }
        }
    }
}





