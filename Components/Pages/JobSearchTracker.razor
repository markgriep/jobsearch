@page "/tracker"
@page "/"

@inject jobsearch.Data.JobSearchDbContext Db
@inject ISnackbar Snackbar
@inject IDialogService DialogService

@using Microsoft.EntityFrameworkCore
@using System.Globalization
@using jobsearch.Dialog

<PageTitle>Job Search Info</PageTitle>

<div class="d-flex align-center" style="gap:8px; margin-bottom:12px;">
    <MudIconButton Icon="@Icons.Material.Filled.Add"
                   Color="Color.Primary"
                   Variant="Variant.Filled"
                   Size="Size.Medium"
                   AriaLabel="Add"
                   OnClick="Add" />
</div>


<MudTable Items="_rows"
    Hover="true" 
    Dense="true" 
    GroupBy="_groupByWeek">

<GroupHeaderTemplate>
    <MudTh colspan="9" 
        Style="background-color: var(--mud-palette-dark); color: var(--mud-palette-dark-text);">
        @FormatWeekGroupHeader(((int Year, int Week))context.Key, context.Items.Count())
    </MudTh>

</GroupHeaderTemplate>
<HeaderContent>
        <MudTh>
            <MudTableSortLabel 
                SortBy="new Func<ActivityLog, object>(x => x.ActivityDate)" 
                SortLabelActive="true"
                SortLabelDirection="SortDirection.Descending">
                Date
            </MudTableSortLabel>
        </MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x => x.BusinessOrOrganization)">Business</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x => x.ActivityPerformed)">Activity</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x => x.TypeOfWork)">Type</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x => x.Results)">Results</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x => x.ContactPerson)">Contact</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x => x.ShouldBeOnDes)">Include?</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x => x.IsOnDes)">On?</MudTableSortLabel></MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>

    <RowTemplate>
        <MudTd DataLabel="Date">@context.ActivityDate.ToString("yyyy-MM-dd")</MudTd>
        <MudTd DataLabel="Business">@context.BusinessOrOrganization</MudTd>
        <MudTd DataLabel="Activity">@context.ActivityPerformed</MudTd>
        <MudTd DataLabel="Type">@context.TypeOfWork</MudTd>
        <MudTd DataLabel="Results">@context.Results</MudTd>
        <MudTd DataLabel="Contact">@context.ContactPerson</MudTd>
        <MudTd DataLabel="Should Be On DES">
            @RenderShouldBeOnDes(context.ShouldBeOnDes)
        </MudTd>
        <MudTd DataLabel="Is Entered On DES">
            @RenderIsDes(context.IsOnDes)
        </MudTd>
        <MudTd>
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" AriaLabel="Edit" OnClick="@(() => Edit(context))" />
        </MudTd>
    </RowTemplate>
</MudTable>

<style>
    .dialog-blur-background {
        backdrop-filter: blur(5px);
        background-color: rgba(255, 255, 255, 0.2);
    }

    .mud-table .mud-table-body .mud-table-row > td:first-child {
        width: 1px;
        padding: 0 4px !important;
        white-space: nowrap;
    }
</style>

@code {
    private List<ActivityLog> _rows = new();

    private static string FormatWeekGroupHeader((int Year, int Week) key, int entryCount)
    {
        var monday = ISOWeek.ToDateTime(key.Year, key.Week, DayOfWeek.Monday);
        var sunday = monday.AddDays(6);
        var dateRange = monday.Month == sunday.Month
            ? $"{monday:MMMM} {monday.Day}-{sunday.Day}"
            : $"{monday:MMMM} {monday.Day} - {sunday:MMMM} {sunday.Day}";
        var label = entryCount == 1 ? "entry" : "entries";
        return $"Week {key.Week} ({dateRange})  {entryCount} {label}";
    }

    private readonly TableGroupDefinition<ActivityLog> _groupByWeek = new()
    {
        GroupName = "Week",
        Selector = x => (ISOWeek.GetYear(x.ActivityDate), ISOWeek.GetWeekOfYear(x.ActivityDate)),
        Expandable = true,
        IsInitiallyExpanded = false
    };

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }


    private RenderFragment RenderShouldBeOnDes(bool value) => builder =>
    {
        builder.OpenComponent<MudIcon>(0);
        builder.AddAttribute(1, "Icon", value ? Icons.Material.Outlined.CheckCircle : Icons.Material.Rounded.Remove);
        builder.AddAttribute(2, "Color", value ? Color.Success : Color.Error);
        builder.AddAttribute(3, "Size", Size.Small);
        builder.CloseComponent();
    };

    private RenderFragment RenderIsDes(bool value) => value
        ? builder =>
        {
            builder.OpenComponent<MudIcon>(0);
            builder.AddAttribute(1, "Icon", Icons.Material.Outlined.ThumbUp);
            builder.AddAttribute(2, "Color", Color.Success);
            builder.AddAttribute(3, "Size", Size.Small);
            builder.CloseComponent();
        }
        : builder => { };



    private async Task ReloadAsync()
    {
        _rows = await Db.ActivityLogs
            .OrderByDescending(x => x.ActivityDate)
            .ToListAsync();
        StateHasChanged();
    }

    private async Task Add()
    {
        var parameters = new DialogParameters { ["Model"] = new ActivityLog() };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true, BackgroundClass = "dialog-blur-background" };
        var dialog = DialogService.Show<ActivityLogDialog>("Add Activity", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled && result.Data is ActivityLog added)
        {
            try
            {
                // Ensure all required fields are populated
                if (added.ActivityDate == default)
                    added.ActivityDate = DateTime.Today;

                added.ActivityDate = added.ActivityDate.Date;
                
                Db.ActivityLogs.Add(added);
                int changes = await Db.SaveChangesAsync();
                
                if (changes > 0)
                {
                    Snackbar.Add($"Activity added successfully", Severity.Success);
                    await ReloadAsync();
                }
                else
                {
                    Snackbar.Add("Warning: No changes were saved", Severity.Warning);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error saving: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task Edit(ActivityLog row)
    {
        var parameters = new DialogParameters { ["Model"] = row };


        var options = new DialogOptions 
        { CloseButton = true, 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            BackgroundClass = "dialog-blur-background" 
        };

        var dialog = DialogService.Show<ActivityLogDialog>("Edit Activity", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is ActivityLog edited)
        {
            try
            {
                row.ActivityDate = edited.ActivityDate;
                row.BusinessOrOrganization = edited.BusinessOrOrganization;
                row.ActivityPerformed = edited.ActivityPerformed;
                row.ContactPerson = edited.ContactPerson;
                row.TypeOfWork = edited.TypeOfWork;
                row.Results = edited.Results;
                row.HowPerformed = edited.HowPerformed;
                row.Notes = edited.Notes;
                row.ShouldBeOnDes = edited.ShouldBeOnDes;
                row.IsOnDes = edited.IsOnDes;

                await Db.SaveChangesAsync();

                Snackbar.Add("Activity updated successfully", Severity.Success);
                await ReloadAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error saving: {ex.Message}", Severity.Error);
            }
        }
    }
}







