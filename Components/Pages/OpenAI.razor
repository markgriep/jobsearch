@page "/openai"
@using jobsearch.Interfaces
@using jobsearch.Configuration
@using MudBlazor
@inject IOpenAIClient OpenAIClient
@inject ISnackbar Snackbar
@inject OpenAiSettings OpenAiSettings

<PageTitle>OpenAI POC</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudPaper Class="pa-6">
        <MudText Variant="Variant.H4" GutterBottom="true">OpenAI API Proof of Concept</MudText>
        
        <MudTextField @bind-Value="apiKey" Label="API Key" InputType="InputType.Password" Class="mb-4" Placeholder="sk-..." />
        <MudTextField @bind-Value="model" Label="Model" Class="mb-4" Placeholder="gpt-4.1-mini" />
        <MudTextField @bind-Value="temperature" Label="Temperature" InputType="InputType.Number" Class="mb-4" Placeholder="0.8"
                      HelperText="0 = deterministic, higher = more creative (max 2.0)" Immediate="true" />
        <MudTextField @bind-Value="input" Label="Input" Class="mb-4" Placeholder="Your prompt here..." Lines="3" />
        
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="TestConnection" Disabled="isLoading">
            Send Request
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Class="ml-2" OnClick="ShowApiKey">
            Show API Key
        </MudButton>

        @if (!string.IsNullOrEmpty(response))
        {
            <MudPaper Class="mt-6 pa-4" Outlined="true">
                <MudText Variant="Variant.H6">Response:</MudText>
                <MudText Class="mt-3">@response</MudText>
                
                <MudDivider Class="my-4" />
                
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudText Variant="Variant.Caption">Total Tokens Used:</MudText>
                        <MudText Variant="Variant.H6">@totalTokens</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }

        @if (isLoading)
        {
            <MudProgressLinear Indeterminate="true" Class="mt-4" />
        }
    </MudPaper>
</MudContainer>

@code {
private string   apiKey = string.Empty;
private string   model = "gpt-4.1-mini";
private double   temperature;                   // Controls randomness.

private string   input = "Write one short sentence about a rainy day.";
private string   response = string.Empty;
private int      totalTokens = 0;
private bool     isLoading = false;

private void ShowApiKey()
{
    if (string.IsNullOrWhiteSpace(OpenAiSettings.ApiKey))
    {
        Snackbar.Add("API key is not configured", Severity.Warning);
        return;
    }

    apiKey = OpenAiSettings.ApiKey;

    var masked = OpenAiSettings.ApiKey.Length <= 8
        ? new string('*', OpenAiSettings.ApiKey.Length)
        : $"{OpenAiSettings.ApiKey[..8]}***{OpenAiSettings.ApiKey[^8..]}";

    Snackbar.Add($"Configured API Key: {masked}", Severity.Info);
}




protected override void OnInitialized()
{
    apiKey = OpenAiSettings.ApiKey;
    temperature = OpenAiSettings.Temperature;
}


private async Task TestConnection()
{
    if (string.IsNullOrWhiteSpace(apiKey))
    {
        Snackbar.Add("Please enter an API key", Severity.Warning);
        return;
    }

    if (string.IsNullOrWhiteSpace(model))
    {
        Snackbar.Add("Please enter a model", Severity.Warning);
        return;
    }

    if (string.IsNullOrWhiteSpace(input))
    {
        Snackbar.Add("Please enter input", Severity.Warning);
        return;
    }

    isLoading = true;
    try
    {
        var request = new OpenAIRequest 
        { 
            Model = model, 
            Input = input,
            Temperature = Math.Clamp(temperature, 0d, 2d)
        };

        var apiResponse = await OpenAIClient.GetResponse($"Bearer {apiKey}", request);
        
        if (apiResponse != null && apiResponse.Output.Count > 0)
        {
            var messageContent = apiResponse.Output[0].Content.FirstOrDefault();
            if (messageContent != null)
            {
                response = messageContent.Text;
                totalTokens = apiResponse.Usage.TotalTokens;
                Snackbar.Add("Request successful!", Severity.Success);
            }
            else
            {
                response = "No content in response";
                Snackbar.Add("No content found in response", Severity.Warning);
            }
        }
        else
        {
            response = "No output in response";
            Snackbar.Add("No output found in response", Severity.Warning);
        }
    }
    catch (Exception ex)
    {
        response = $"Error: {ex.Message}\n\nDetails: {ex.InnerException?.Message}";
        totalTokens = 0;
        Snackbar.Add($"Connection failed: {ex.Message}", Severity.Error);
        Console.WriteLine($"OpenAI API Error: {ex}");
    }
    finally
    {
        isLoading = false;
    }
}
}
